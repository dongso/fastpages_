<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How to use fastai tabular with custom metric | Data Science Blog von lschmiddey</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="How to use fastai tabular with custom metric" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html" />
<meta property="og:url" content="https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html" />
<meta property="og:site_name" content="Data Science Blog von lschmiddey" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-01T00:00:00-05:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"How to use fastai tabular with custom metric","dateModified":"2020-10-01T00:00:00-05:00","datePublished":"2020-10-01T00:00:00-05:00","url":"https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/fastpages_/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://lschmiddey.github.io/fastpages_/feed.xml" title="Data Science Blog von lschmiddey" /><link rel="shortcut icon" type="image/x-icon" href="/fastpages_/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How to use fastai tabular with custom metric | Data Science Blog von lschmiddey</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="How to use fastai tabular with custom metric" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html" />
<meta property="og:url" content="https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html" />
<meta property="og:site_name" content="Data Science Blog von lschmiddey" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-01T00:00:00-05:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"How to use fastai tabular with custom metric","dateModified":"2020-10-01T00:00:00-05:00","datePublished":"2020-10-01T00:00:00-05:00","url":"https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://lschmiddey.github.io/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://lschmiddey.github.io/fastpages_/feed.xml" title="Data Science Blog von lschmiddey" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/fastpages_/">Data Science Blog von lschmiddey</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/fastpages_/about/">About Me</a><a class="page-link" href="/fastpages_/search/">Search</a><a class="page-link" href="/fastpages_/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">How to use fastai tabular with custom metric</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-10-01T00:00:00-05:00" itemprop="datePublished">
        Oct 1, 2020
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      7 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/lschmiddey/fastpages_/tree/master/_notebooks/2020-10-01-Tabular-Data-with-custom-metric.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/fastpages_/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/lschmiddey/fastpages_/master?filepath=_notebooks%2F2020-10-01-Tabular-Data-with-custom-metric.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/fastpages_/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/lschmiddey/fastpages_/blob/master/_notebooks/2020-10-01-Tabular-Data-with-custom-metric.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/fastpages_/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-10-01-Tabular-Data-with-custom-metric.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-easily-train-a-tabular-model-with-fastai">How to easily train a tabular model with fastai<a class="anchor-link" href="#How-to-easily-train-a-tabular-model-with-fastai"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First, we have to load our data (I used the kaggle API to do this, check out my previous <a href="https://lschmiddey.github.io/fastpages_/2020/09/15/get-kaggle-api-started.html">blogpost</a>)</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/notebooks/storage/data/Titanic&#39;</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/notebooks/storage/data/Titanic/titanic.zip&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>unzip -q <span class="o">{</span>str<span class="o">(</span>filename<span class="o">)}</span> -d <span class="o">{</span>str<span class="o">(</span>p/<span class="s2">&quot;train&quot;</span><span class="o">)}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Get-imports">Get imports<a class="anchor-link" href="#Get-imports"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">is_string_dtype</span><span class="p">,</span> <span class="n">is_numeric_dtype</span><span class="p">,</span> <span class="n">is_categorical_dtype</span>
<span class="kn">from</span> <span class="nn">fastai.tabular.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">/train/train.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Survived</th>
      <th>Pclass</th>
      <th>Name</th>
      <th>Sex</th>
      <th>Age</th>
      <th>SibSp</th>
      <th>Parch</th>
      <th>Ticket</th>
      <th>Fare</th>
      <th>Cabin</th>
      <th>Embarked</th>
    </tr>
    <tr>
      <th>PassengerId</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>887</th>
      <td>0</td>
      <td>2</td>
      <td>Montvila, Rev. Juozas</td>
      <td>male</td>
      <td>27.0</td>
      <td>0</td>
      <td>0</td>
      <td>211536</td>
      <td>13.00</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>888</th>
      <td>1</td>
      <td>1</td>
      <td>Graham, Miss. Margaret Edith</td>
      <td>female</td>
      <td>19.0</td>
      <td>0</td>
      <td>0</td>
      <td>112053</td>
      <td>30.00</td>
      <td>B42</td>
      <td>S</td>
    </tr>
    <tr>
      <th>889</th>
      <td>0</td>
      <td>3</td>
      <td>Johnston, Miss. Catherine Helen "Carrie"</td>
      <td>female</td>
      <td>NaN</td>
      <td>1</td>
      <td>2</td>
      <td>W./C. 6607</td>
      <td>23.45</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>890</th>
      <td>1</td>
      <td>1</td>
      <td>Behr, Mr. Karl Howell</td>
      <td>male</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>111369</td>
      <td>30.00</td>
      <td>C148</td>
      <td>C</td>
    </tr>
    <tr>
      <th>891</th>
      <td>0</td>
      <td>3</td>
      <td>Dooley, Mr. Patrick</td>
      <td>male</td>
      <td>32.0</td>
      <td>0</td>
      <td>0</td>
      <td>370376</td>
      <td>7.75</td>
      <td>NaN</td>
      <td>Q</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(891, 11)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's check out the data type for each column.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Survived      int64
Pclass        int64
Name         object
Sex          object
Age         float64
SibSp         int64
Parch         int64
Ticket       object
Fare        float64
Cabin        object
Embarked     object
dtype: object</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We see that "Pclass", "Sex", "Cabin" and "Embarked" are objects. When we think about these variables, they clearly are categorical variables. So let's change that.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Sex&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Sex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Cabin&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Cabin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Embarked&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Embarked&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I want to build a validation set, based on the index. The easiest way is to create an array with the length of our data, randomly select a percentage of indeces we want in our training data, and use the leftover indeces for our validation set.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Define percentage of train data, define length of training indeces and validation indeces</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">len_df</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">len_idx_tain</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">len_df</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="n">len_idx_val</span> <span class="o">=</span> <span class="n">len_df</span><span class="o">-</span><span class="n">len_idx_tain</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># build array of indeces for training and validation</span>
<span class="n">idx_arr</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">len_df</span><span class="p">)</span>
<span class="n">train_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">len_df</span><span class="p">),</span> <span class="n">len_idx_tain</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">val_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_arr</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">train_idx</span><span class="p">]</span>
<span class="n">val_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val_idx</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's put these arrays into a split variable, which fastai knows how to make use of to split the data into training data and validation data.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">splits</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">train_idx</span><span class="p">),</span><span class="nb">list</span><span class="p">(</span><span class="n">val_idx</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we make use of the "cont_cat_split" function to easily get a list of column names for each categorical and continuous variable.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cont_nn</span><span class="p">,</span> <span class="n">cat_nn</span> <span class="o">=</span> <span class="n">cont_cat_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dep_var</span><span class="o">=</span><span class="s1">&#39;Survived&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cont_nn</span><span class="p">,</span> <span class="n">cat_nn</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>([&#39;Age&#39;, &#39;Fare&#39;],
 [&#39;Pclass&#39;, &#39;Name&#39;, &#39;Sex&#39;, &#39;SibSp&#39;, &#39;Parch&#39;, &#39;Ticket&#39;, &#39;Cabin&#39;, &#39;Embarked&#39;])</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>That looks great! How about our missing values?</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Survived      0
Pclass        0
Name          0
Sex           0
Age         177
SibSp         0
Parch         0
Ticket        0
Fare          0
Cabin       687
Embarked      2
dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Looks like there are quite a few missing values for age and cabin. But we know a way to make use of that! Even "no-information" can be an information.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">procs_nn</span> <span class="o">=</span> <span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Fastai provides us with many super useful out-of-the-box functions. Three of them you can see here: Categorify will take all of the variables with type "category" will replace the category with a numerical number and write the mapping into a dictionary. FillMissing, well, does exactly this. It also provides us with a extra boolean variable, indicating whether the row has a missing value for a specific variable (e.g. age). Normalize then normalizes our continuous data and saves the standardzier.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Survived&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Survived&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This one is important: fastai needs the dependend variable to be of type float32, even though we have a binary classification! We need this, because the loss function will be mse-loss. This leads to possibly odd behavior: the numbers can get below 0 and even below -1 or above 2! If we use a provided metric like accuracy, this leads to odd results. So we will write our own custom metric! But first, let's use the TabularPandas class and put that in a dataloader (important: do not let the batchsize become bigger than your data, this will result in a error!).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">to_nn</span> <span class="o">=</span> <span class="n">TabularPandas</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">procs_nn</span><span class="p">,</span> <span class="n">cat_nn</span><span class="p">,</span> <span class="n">cont_nn</span><span class="p">,</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span> <span class="n">y_names</span><span class="o">=</span><span class="s1">&#39;Survived&#39;</span><span class="p">)</span>
<span class="c1"># length of data is 891, so let the batchsize be smaller than that!</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">to_nn</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Train-Model">Train Model<a class="anchor-link" href="#Train-Model"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now is the time to train our model. But wait! We first have to define a custom metric, because the accuracy provided by fastai will lead to odd results. I can show you what I mean:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">accuracy</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mf">1e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.336898</td>
      <td>0.462910</td>
      <td>0.584270</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.261536</td>
      <td>0.425619</td>
      <td>0.584270</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.195133</td>
      <td>0.385734</td>
      <td>0.584270</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.153365</td>
      <td>0.351687</td>
      <td>0.584270</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>What is going on here? Is the accuracy not improving? The answer is no. Tabular<em>learner in combination with accuracy does not give us the result we want. Why is that? First, our predictions will not be 0 or 1, but floating point values. That's good for our loss, so our model can learn from its gradient (checkout my blogpost about [gradients](<a href="https://lschmiddey.github.io/fastpages">https://lschmiddey.github.io/fastpages</a></em>/2020/09/01/Gradient-Descent.html) if you do not know what that means). But this leads to a malfunctioning of the accuracy metric, which fastai uses from sklearn. What we need to do is to define our own custom metric. Let's do that!</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">sklearn.metrics</span> <span class="k">as</span> <span class="nn">skm</span>
 
<span class="k">def</span> <span class="nf">_accumulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learn</span><span class="p">):</span>
    <span class="c1">#pred = learn.pred.argmax(dim=self.dim_argmax) if self.dim_argmax else learn.pred</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">pred</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">y</span>
    <span class="n">pred</span><span class="p">,</span><span class="n">targ</span> <span class="o">=</span> <span class="n">to_detach</span><span class="p">(</span><span class="n">pred</span><span class="p">),</span><span class="n">to_detach</span><span class="p">(</span><span class="n">targ</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">targs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">targ</span><span class="p">)</span>

<span class="n">AccumMetric</span><span class="o">.</span><span class="n">accumulate</span> <span class="o">=</span> <span class="n">_accumulate</span>

<span class="k">def</span> <span class="nf">BinAccu</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">skm_to_fastai</span><span class="p">(</span><span class="n">skm</span><span class="o">.</span><span class="n">accuracy_score</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So what's going on here? Next to Callbacks, fastai provides a clever way how to customize metrics. To be honest, it took me some time to figure it out, but here's how it works. Each learner has a .pred and a .y, which means this is how you can get its predictions and its targets. As I already mentioned, preds are floating point values, but we want them to be between 0 and 1 - luckily, this is exactly what the sigmoid function is doing. Then we want the values to be either 0 or 1, so let's just round these values (threshold here is .5, but you can fiddle around with that). We then append these "new" preds and targets.</p>
<p>"In order to provide a more flexible foundation to support metrics like this fastai provides a Metric abstract class which defines three methods: reset, accumulate, and value (which is a property). Reset is called at the start of training, accumulate is called after each batch, and then finally value is called to calculate the final check."</p>
<p>So with this function we directly sit on top of accumulate. The function skm_to_fastai let's you use sklearn metrics (in this case: accuracy_score) and uses the pred and targ we provided in our tiny function. Important: we have to instanciate the instance first!</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">binaccu</span> <span class="o">=</span> <span class="n">BinAccu</span><span class="p">()</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">binaccu</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ok, we're good to go. Let's use fastai's awesome lr_find().</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SuggestedLRs(lr_min=0.04365158379077912, lr_steep=0.001737800776027143)</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
" />
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Looks like we should set our learning rate to about 1e-3.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mf">1e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_score</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.408988</td>
      <td>0.484313</td>
      <td>0.584270</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.354359</td>
      <td>0.457268</td>
      <td>0.584270</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.275204</td>
      <td>0.412495</td>
      <td>0.516854</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.213265</td>
      <td>0.358083</td>
      <td>0.415730</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.170837</td>
      <td>0.307841</td>
      <td>0.415730</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.140746</td>
      <td>0.273276</td>
      <td>0.415730</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.118833</td>
      <td>0.252393</td>
      <td>0.415730</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.102209</td>
      <td>0.241727</td>
      <td>0.415730</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.089564</td>
      <td>0.236333</td>
      <td>0.415730</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.079208</td>
      <td>0.234298</td>
      <td>0.415730</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our accuracy is improving until epoch 3. So we should restart our training. But first, let's have a look, whether our accuracy score is doing what we expect:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preds</span><span class="p">,</span> <span class="n">targs</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">()</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
<span class="n">confusion_matrix</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">targs</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([[ 0,  0],
       [52, 37]])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">-</span> <span class="n">targs</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">-</span> <span class="n">targs</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.4157)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Awesome. That's exactly what we wanted (not the result, which is pretty bad ;) )</p>
<p>Let's re-run the trainig.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">binaccu</span> <span class="o">=</span> <span class="n">BinAccu</span><span class="p">()</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">128</span><span class="p">],</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">binaccu</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mf">1e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_score</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.384979</td>
      <td>0.454870</td>
      <td>0.584270</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.272718</td>
      <td>0.439553</td>
      <td>0.584270</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.202698</td>
      <td>0.423993</td>
      <td>0.640449</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preds</span><span class="p">,</span> <span class="n">targs</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">()</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
<span class="n">confusion_matrix</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">targs</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([[49, 29],
       [ 3,  8]])</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To be honest, the results aren't quite that good. With a RandomForest you can easily get up to 85% accuracy. However, in this blogpost I wanted to show you how to leverage fastai's tabular_learner and add a custom metric to it.</p>
<p>I hope you stay tuned for the next blogpost!</p>
<p>Lasse</p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/fastpages_/2020/10/01/Tabular-Data-with-custom-metric.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/fastpages_/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/fastpages_/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/fastpages_/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/lschmiddey" title="lschmiddey"><svg class="svg-icon grey"><use xlink:href="/fastpages_/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
